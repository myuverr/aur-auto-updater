# SPDX-License-Identifier: MPL-2.0
name: AUR Auto Updater

on:
  schedule:
    - cron: "0 0,12 * * *" # 00:00 and 12:00 UTC daily
  workflow_dispatch: # Manual trigger

concurrency:
  group: aur-update
  cancel-in-progress: false

permissions:
  contents: read

defaults:
  run:
    # Enforce strict shell semantics for all run steps
    shell: bash -euo pipefail {0}

env:
  # Shared retry settings
  RETRY_MAX_ATTEMPTS: 4
  RETRY_DELAY_BASE: 3
  AUR_RATE_LIMIT_DELAY: 5

jobs:
  # Detect update candidates
  check-versions:
    runs-on: ubuntu-latest
    container: archlinux:base-devel
    timeout-minutes: 10
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_updates: ${{ steps.set-matrix.outputs.has_updates }}
      error_count: ${{ steps.set-matrix.outputs.error_count }}

    steps:
      - name: Checkout Config
        uses: actions/checkout@v6

      - name: Install Tools
        uses: ./.github/actions/install-aur-tools
        with:
          packages: nvchecker jq

      - name: Generate Nvchecker Config
        env:
          PACKAGES_CONFIG: ${{ vars.PACKAGES_CONFIG }}
          GH_PAT: ${{ secrets.GH_PAT }}
        run: bash "$GITHUB_WORKSPACE/.github/scripts/generate-nvchecker-config.sh"

      - name: Check Package Versions
        id: set-matrix
        run: bash "$GITHUB_WORKSPACE/.github/scripts/check-versions.sh"

      - name: Cleanup Keyfile
        if: always()
        run: rm -f keyfile.toml

  # Update packages concurrently
  update-package:
    needs: check-versions
    if: needs.check-versions.outputs.has_updates == 'true'
    runs-on: ubuntu-latest
    container: archlinux:base-devel
    timeout-minutes: 30

    strategy:
      matrix: ${{ fromJson(needs.check-versions.outputs.matrix) }}
      fail-fast: false

    steps:
      - name: Checkout for Composite Action
        uses: actions/checkout@v6
        with:
          sparse-checkout: |
            .github/actions
            .github/scripts
          sparse-checkout-cone-mode: false

      - name: Install Tools
        uses: ./.github/actions/install-aur-tools
        with:
          packages: pacman-contrib
          create-builder: "true"

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.AUR_SSH_KEY }}

      - name: Configure SSH Known Hosts
        uses: ./.github/actions/setup-aur-ssh

      - name: Update ${{ matrix.package }}
        env:
          PKG: ${{ matrix.package }}
          VERSION: ${{ matrix.version }}
        run: bash "$GITHUB_WORKSPACE/.github/scripts/update-package.sh"

  # Aggregate job outcomes and fail on errors
  report-status:
    if: always()
    needs: [check-versions, update-package]
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Evaluate Results
        env:
          ERROR_COUNT: ${{ needs.check-versions.outputs.error_count }}
          CHECK_RESULT: ${{ needs.check-versions.result }}
          UPDATE_RESULT: ${{ needs.update-package.result }}
        run: |
          failed=false

          if [ "${ERROR_COUNT:-0}" -gt 0 ]; then
            echo "::error::$ERROR_COUNT package(s) had version-check errors (see check-versions summary)"
            failed=true
          fi

          if [ "$CHECK_RESULT" = "failure" ] || [ "$CHECK_RESULT" = "cancelled" ]; then
            echo "::error::check-versions job $CHECK_RESULT"
            failed=true
          fi

          # update-package is expected to be skipped when no updates are found
          if [ "$UPDATE_RESULT" = "failure" ] || [ "$UPDATE_RESULT" = "cancelled" ]; then
            echo "::error::update-package job $UPDATE_RESULT (see update-package summary)"
            failed=true
          fi

          if [ "$failed" = "true" ]; then
            echo "::error::Workflow completed with errors â€” review job summaries above"
            exit 1
          fi

          echo "All checks and updates completed successfully"
