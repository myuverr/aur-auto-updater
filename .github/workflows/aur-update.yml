# SPDX-License-Identifier: MPL-2.0
name: AUR Auto Updater

on:
  schedule:
    - cron: "0 0,12 * * *" # Run at 0:00 and 12:00 UTC daily
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write

concurrency:
  group: aur-update
  cancel-in-progress: false

defaults:
  run:
    # Use bash with strict mode to catch errors early
    # -e: exit on error, -u: error on undefined vars, -o pipefail: catch pipe failures
    shell: bash -euo pipefail {0}

env:
  # Retry configuration
  RETRY_MAX_ATTEMPTS: 4
  RETRY_DELAY_BASE: 3
  AUR_RATE_LIMIT_DELAY: 5
  # Job summary size limit (GitHub limit is 1MB, leave margin)
  MAX_SUMMARY_SIZE: 900000

jobs:
  # Job 1: Check which packages need updates
  check-versions:
    runs-on: ubuntu-latest
    container: archlinux:base-devel
    timeout-minutes: 10
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_updates: ${{ steps.set-matrix.outputs.has_updates }}

    steps:
      - name: Checkout Config
        uses: actions/checkout@v6

      - name: Install Tools
        uses: ./.github/actions/install-aur-tools
        with:
          packages: nvchecker jq

      - name: Generate Nvchecker Config
        env:
          PACKAGES_CONFIG: ${{ vars.PACKAGES_CONFIG }}
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          # shellcheck shell=bash
          if [ -z "${PACKAGES_CONFIG:-}" ]; then
            echo "::error::PACKAGES_CONFIG variable not set. Configure it in repository settings."
            exit 1
          fi

          # Generate keyfile.toml with GH_PAT
          echo '[keys]' > keyfile.toml
          echo "github = \"$GH_PAT\"" >> keyfile.toml

          # Generate nvchecker.toml header with keyfile reference
          cat > nvchecker.toml << 'EOF'
          [__config__]
          oldver = "old_ver.json"
          keyfile = "keyfile.toml"
          EOF

          # Parse JSON and generate package sections
          echo "$PACKAGES_CONFIG" | jq -r 'to_entries[] | 
            "[\(.key)]\nsource = \"github\"\ngithub = \"\(.value.github)\"\n" +
            (if .value.use_latest_release then "use_latest_release = true\n" else "" end) +
            (if .value.use_max_tag then "use_max_tag = true\n" else "" end) +
            (if .value.prefix then "prefix = \"\(.value.prefix)\"\n" else "" end) +
            (if .value.include_regex then "include_regex = '\''\(.value.include_regex)'\''\n" else "" end)
          ' >> nvchecker.toml

          # Extract package names for iteration
          PACKAGES=$(echo "$PACKAGES_CONFIG" | jq -r 'keys | join(" ")')
          echo "PACKAGES=$PACKAGES" >> "$GITHUB_ENV"

          echo "Generated nvchecker.toml for packages: $PACKAGES"

      - name: Check Package Versions
        id: set-matrix
        run: bash "$GITHUB_WORKSPACE/.github/scripts/check-versions.sh"

      - name: Fail if Errors Occurred
        if: steps.set-matrix.outputs.error_count != '0'
        run: |
          echo "::error::Version check completed with errors. Check the summary for details."
          exit 1

  # Job 2: Update each package in parallel
  update-package:
    needs: check-versions
    if: needs.check-versions.outputs.has_updates == 'true'
    runs-on: ubuntu-latest
    container: archlinux:base-devel
    timeout-minutes: 30

    strategy:
      matrix: ${{ fromJson(needs.check-versions.outputs.matrix) }}
      fail-fast: false

    steps:
      - name: Checkout for Composite Action
        uses: actions/checkout@v6
        with:
          sparse-checkout: |
            .github/actions
            .github/scripts
          sparse-checkout-cone-mode: false

      - name: Install Tools
        uses: ./.github/actions/install-aur-tools
        with:
          packages: pacman-contrib
          create-builder: "true"

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.AUR_SSH_KEY }}

      - name: Configure SSH Known Hosts
        uses: ./.github/actions/setup-aur-ssh

      - name: Update ${{ matrix.package }}
        id: update
        env:
          PKG: ${{ matrix.package }}
          VERSION: ${{ matrix.version }}
        run: bash "$GITHUB_WORKSPACE/.github/scripts/update-package.sh"

      - name: Update Summary
        if: always()
        env:
          PKG: ${{ matrix.package }}
          VERSION: ${{ matrix.version }}
          STATUS: ${{ steps.update.outputs.status }}
          RESULT: ${{ steps.update.outcome }}
        run: |
          {
            echo "## Update Result: $PKG"
            echo ""
            echo "| Package | Version | Status |"
            echo "|---------|---------|--------|"
            if [ "$RESULT" = "success" ]; then
              if [ "$STATUS" = "success" ]; then
                echo "| $PKG | $VERSION | ✅ Updated |"
              else
                echo "| $PKG | $VERSION | ⚠️ No changes |"
              fi
            else
              echo "| $PKG | $VERSION | ❌ Failed |"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
